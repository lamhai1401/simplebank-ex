# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

executors:
  docker-publisher:
    environment:
      IMAGE_NAME: lamhai141/simplebank-ex
    docker:
    - image: circleci/buildpack-deps:stretch

orbs:
  heroku: circleci/heroku@1.2.6

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    working_directory: ~/repo
    environment:
      IMAGE_NAME: lamhai141/simplebank-ex
    docker:
    - image: cimg/go:1.15.10
    - image: circleci/buildpack-deps:stretch
    steps:
    - checkout
    - restore_cache:
        keys:
        - go-mod-v4-{{ checksum "go.sum" }}
    - run:
        name: Install Dependencies
        command: go get ./...
    - save_cache:
        key: go-mod-v4-{{ checksum "go.sum" }}
        paths:
        - /go/pkg/mod

    - run:
        name: Run all tests
        command: make test

    - setup_remote_docker

    - run:
        name: Build Docker image
        command: docker build -t $IMAGE_NAME:test .

    - run:
        name: Archive Docker image
        command: docker save -o image.tar $IMAGE_NAME

    - persist_to_workspace:
        root: .
        paths:
        - ./image.tar

  publish-tag:
    executor: docker-publisher
    environment:
      IMAGE_TAG: ${CIRCLE_TAG/v/test}
    steps:
    - attach_workspace:
        at: /tmp/workspace
    - setup_remote_docker
    - run:
        name: Load archived Docker image
        command: docker load -i /tmp/workspace/image.tar
    - run:
        name: Login to docker
        command: docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWD
    - run:
        name: Tag docker
        command: docker tag $IMAGE_NAME:test $IMAGE_NAME:$IMAGE_TAG
    - run:
        name: Publish Docker Image to Docker Hub
        command: docker push $IMAGE_NAME:$IMAGE_TAG

workflows:
  version: 2
  build-master:
    jobs:
    - build:
        filters:
          branches:
            only: staging
            ignore: /.*/
          tags:
            only: /^v.*/

    - publish-tag:
        requires:
        - build
        filters:
          branches:
            only: staging
            ignore: /.*/
          tags:
            only: /^v.*/

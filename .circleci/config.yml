# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  heroku: circleci/heroku@1.2.6

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    working_directory: ~/repo
    environment:
      IMAGE_NAME: lamhai141/simplebank-ex
    docker:
    - image: cimg/go:1.15.10
    - image: circleci/buildpack-deps:stretch
    steps:
    - checkout
    - restore_cache:
        keys:
        - go-mod-v4-{{ checksum "go.sum" }}
    - run:
        name: Install Dependencies
        command: go get ./...
    - save_cache:
        key: go-mod-v4-{{ checksum "go.sum" }}
        paths:
        - /go/pkg/mod

    - run:
        name: Run all tests
        command: make test

    - setup_remote_docker

    - run:
        name: Build Docker image
        command: docker build -t $IMAGE_NAME:test .

  publish-latest:
    environment:
      IMAGE_NAME: lamhai141/simplebank-ex:test
    docker:
    - image: circleci/buildpack-deps:stretch
    steps:
    - setup_remote_docker
    - run:
        name: Login to docker
        command: docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWD
    - run:
        name: Publish Docker Image to Docker Hub
        command: docker push $IMAGE_NAME:test

workflows:
  version: 2
  build-master:
    jobs:
    - build:
        filters:
          branches:
            only: staging
    - publish-latest:
        requires:
        - build
        filters:
          branches:
            only: staging
